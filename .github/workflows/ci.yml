name: QuantumCoin CI
on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  rust-blockchain:
    name: Rust Blockchain Core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/hostedtoolcache
          docker system prune -af
          df -h
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Format check
        run: cargo fmt --all -- --check
      - name: Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings
      - name: Build workspace
        run: cargo build --workspace --all-features
      - name: Run tests
        run: cargo test --workspace --all-features -- --nocapture

  genesis-validation:
    name: Genesis Block Generation
    runs-on: ubuntu-latest
    needs: rust-blockchain
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build genesis generator
        run: cargo build --bin generate-genesis
      - name: Generate mainnet genesis
        run: cargo run --bin generate-genesis
      - name: Verify genesis deterministic
        run: |
          cargo run --bin generate-genesis > genesis1.json
          cargo run --bin generate-genesis > genesis2.json
          diff genesis1.json genesis2.json || (echo "Genesis not deterministic!" && exit 1)

  cli-tools:
    name: CLI Tools Test
    runs-on: ubuntu-latest
    needs: rust-blockchain
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build CLI wallet
        run: cargo build --bin quantumcoin-cli
      - name: Test wallet creation
        run: |
          mkdir -p /tmp/quantumcoin-test
          cargo run --bin quantumcoin-cli -- --datadir /tmp/quantumcoin-test wallet create --name test
          cargo run --bin quantumcoin-cli -- --datadir /tmp/quantumcoin-test wallet list

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: rust-blockchain
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run integration tests
        run: cargo test --test integration_tests -- --nocapture
      - name: Run stress tests
        run: cargo test --test integration_tests stress_tests -- --nocapture

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Security audit
        run: cargo audit
      - name: Check for unsafe code
        run: |
          if grep -r "unsafe " src/ crates/; then
            echo "Unsafe code found - review required"
            exit 1
          fi

  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: rust-blockchain
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build release
        run: cargo build --release
      - name: Performance benchmark
        run: |
          echo "Running UTXO performance test..."
          timeout 60s cargo test --release --test integration_tests test_large_utxo_set_performance -- --nocapture
          echo "Running mempool performance test..."
          timeout 60s cargo test --release --test integration_tests test_mempool_high_load -- --nocapture

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check documentation files exist
        run: |
          test -f README.md || (echo "README.md missing" && exit 1)
          test -f PROGRESS_REPORT.md || (echo "PROGRESS_REPORT.md missing" && exit 1)
          test -f CRYPTOCURRENCY_LAUNCH_STATUS.md || (echo "Launch status missing" && exit 1)
          test -f chain_spec.toml || (echo "Chain spec missing" && exit 1)
      - name: Validate chain spec
        run: |
          if grep -q "TODO" chain_spec.toml; then
            echo "Chain spec contains TODO items"
            exit 1
          fi

  compatibility:
    name: Cross Platform Build
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build for platform
        run: cargo build --workspace
      - name: Run basic tests
        run: cargo test --lib --workspace

  release-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [rust-blockchain, cli-tools, integration-tests]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build release binaries
        run: |
          cargo build --release --bin quantumcoin-cli
          cargo build --release --bin generate-genesis
          cargo build --release --bin quantumcoin
      - name: Create release directory
        run: |
          mkdir -p release/
          cp target/release/quantumcoin-cli release/
          cp target/release/generate-genesis release/
          cp target/release/quantumcoin release/
          cp chain_spec.toml release/
          cp README.md release/
      - name: Generate checksums
        run: |
          cd release/
          sha256sum * > SHA256SUMS.txt
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: quantumcoin-release
          path: release/
